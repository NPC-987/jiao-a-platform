<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產品列表</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/my.css">
    <link rel="stylesheet" href="css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <style>
        #s01 i {
            animation-duration: 2s
        }

        #s01 span {
            white-space: nowrap;
            /* 避免斷行 */
        }
    </style>

</head>

<body class="bg-secondary">
    <!-- 防詐提醒條 -->
    <section id="s01" class="bg-danger text-light">
        <div class="container d-flex justify-content-center align-items-center py-2">
            <i class="fa-solid fa-triangle-exclamation me-2 animate__animated animate__flash animate__infinite"></i>
            <span class="fw-bold fs-5">防詐提醒：</span>
            <span class="ms-1 fs-5">所有交易請透過平台支付系統完成，請勿私下轉帳！</span>
        </div>
    </section>

    <!-- 選單 -->
    <section class="s02 bg-dark">
        <div class="container">
            <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
                <div class="container-fluid">
                    <a class="navbar-brand" href="http://localhost/project/20250812-index.html">
                        <i class="fa-solid fa-kiwi-bird btn btn-outline-success fa-2x me-2"></i>
                        焦阿的二手平台
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page"
                                    href="http://localhost/project/20250812-index.html">
                                    <i class="fa-solid fa-house text-primary me-2"></i>首頁
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="20250812-product01-market.html">
                                    <i class="fa-solid fa-shop text-info me-2"></i>賣場列表
                                </a>
                            </li>
                            <li id="productadd" class="nav-item d-none">
                                <a class="nav-link" href="20250812-product01-add.html">
                                    <i class="fa-solid fa-bag-shopping text-primary me-2"></i>新增產品
                                </a>
                            </li>
                            <li id="productlist" class="nav-item d-none">
                                <a class="nav-link" href="20250812-product01-list.html">
                                    <i class=" fa-solid fa-truck text-info me-2"></i>產品列表
                                </a>
                            </li>
                        </ul>
                        <div>
                            <!-- 註冊/登入按鈕（未登入時顯示）未引入功能先引導到首頁 -->
                            <a href="http://localhost/project/20250812-index.html">
                                <button class="btn btn-outline-warning me-2" data-bs-toggle="modal"
                                    data-bs-target="#registerModal" id="s02_register_btn">註冊</button>
                            </a>
                            <a href="http://localhost/project/20250812-index.html">
                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#loginModal"
                                    id="s02_login_btn">登入</button>
                            </a>
                            <!-- 歡迎詞（登入後顯示） -->
                            <span class="text-success fs-3 me-3 d-none" id="login_showmessage">
                                歡迎 <span class="text-warning fs-3 fw-900" id="login_showmessage2">XXX</span>
                            </span>

                            <!-- 控制台（管理員才顯示） -->
                            <a href="20250902-control.html" class="fs-5 fw-900 btn btn-info d-none"
                                id="s02_control_btn">控制台</a>

                            <!-- 登出（登入後顯示） -->
                            <a href="20250812-index.html" class="fs-5 fw-900 btn btn-danger d-none"
                                id="logout_btn">登出</a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </section>

    <!-- 商品容器 -->
    <div class="container">
        <div class="row" id="mydata">
            <div class="col-md-3 mt-3">
                <div class="card shadow-lg">
                    <img src="images/coffee01.png" class="card-img-top" alt="...">
                    <div class="card-body">
                        <h5 class="card-title fs-2 fw-900">產品名稱</h5>
                        <p class="card-text">價格: <span class="fs-3 fw-900 text-danger">199</span>元</p>
                        <p class="card-text">狀態: <span class="fs-3 fw-900 text-success">正常</span></p>
                        <p class="card-text">說明: <span class="fs-3 fw-900 text-success">說明產品內容</span></p>
                        <div class="text-center">
                            <a href="#" class="btn btn-warning">更新</a>
                            <a href="#" class="btn btn-primary">刪除</a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 跳出更新介面 -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header text-bg-warning">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">產品更新</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body fw-700">
                    <div class="mb-3">
                        <label for="" class="form-label fs-5">產品名稱</label>
                        <input type="text" class="form-control" name="" id="pname" disabled>
                    </div>

                    <div class="mb-3">
                        <label for="" class="form-label fs-5">產品價格(產品價格1~10000元)</label>
                        <input type="number" class="form-control is-valid" id="price" value="50" min="1" max="10000">
                        <!-- <div class="form-text">不會記錄任何資訊</div> -->
                        <div class="valid-feedback" id="price_valid-feedback">價格符合規定</div>
                        <div class="invalid-feedback" id="price_invalid-feedback">價格不符合規定</div>
                    </div>

                    <div class=" fs-5 fw-900 mb-2 form-label text-primary ">請選擇狀態</div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" value="全新" name="radio_pice" checked>
                        <label for="" class="form-check-label">全新</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" value="八成新" name="radio_pice">
                        <label for="" class="form-check-label">八成新</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" value="堪用" name="radio_pice">
                        <label for="" class="form-check-label">堪用</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" value="其他" name="radio_pice">
                        <label for="" class="form-check-label">其他</label>
                    </div>

                    <div class="mt-3">
                        <p class="card-text fs-5">說明:
                            <span class="text-danger">(最多100字)</span>
                        </p>
                        <textarea id="pnote" class="form-control " rows="5" maxlength="100"
                            placeholder="賣方簡短描述、配件、瑕疵說明…">
                            </textarea>
                    </div>

                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-Close"
                            data-bs-dismiss="modal">取消</button>
                        <button class="btn btn-outline-primary" id="updateModal_update_btn">確認更新</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/auth.js"></script>
    <script>
        let u_id; //for update
        let flag_price = false;
        $(function () {
            $.ajax({
                type: "GET",
                url: "20250812-product01-contron-API.php?action=getalldata",
                dataType: "json",
                async: false,
                success: showdata_getalldata,
                error: function () {
                    Swal.fire({
                        title: "這個連線錯誤  - 20250812-product01-contron-API.php?action=getalldata",
                        icon: "error",
                        confirmButtonText: "確認",
                        draggable: true
                    });
                }
            });

            //更新按鈕監聽 #update_btn
            $("#mydata #update_btn").click(function () {
                console.log($(this).data("id"));
                console.log($(this).data("pname"));
                console.log($(this).data("price"));
                console.log($(this).data("pice"));
                console.log($(this).data("pnote"));

                let mypice = $(this).data("pice");

                u_id = $(this).data("id");
                $("#pname").val($(this).data("pname"));
                $("#price").val($(this).data("price"));
                $("#pnote").val($(this).data("pnote"));
                $("input[name='radio_pice']").filter(function () {
                    return $(this).val() === mypice;
                }).prop("checked", true);
            });

            //刪除按鈕監聽 #delete_btn
            $("#mydata #delete_btn").click(function () {
                Swal.fire({
                    title: "確認刪除此筆資料?",
                    showDenyButton: true,
                    showCancelButton: false,
                    confirmButtonText: "確認刪除",
                    denyButtonText: `取消`
                }).then((result) => {
                    if (result.isConfirmed) {
                        console.log($(this).data("id"));
                        var jsonDATA = {};
                        jsonDATA["id"] = $(this).data("id");
                        console.log(JSON.stringify(jsonDATA));

                        //傳遞至後端API 執行刪除
                        $.ajax({
                            type: "POST",
                            url: "20250812-product01-contron-API.php?action=deleteproduct",
                            data: JSON.stringify(jsonDATA),
                            dataType: "json",
                            success: showdata_delete,
                            error: function () {
                                Swal.fire({
                                    title: "刪除錯誤! - 20250812-product01-contron-API.php?action=deleteproduct",
                                    icon: "error",
                                    draggable: true
                                });
                            }
                        });
                    }
                });
            });

            //按鈕監聽#updateModal_update_btn
            $("#updateModal_update_btn").click(function () {
                var jsonDATA = {};
                jsonDATA["id"] = u_id;
                jsonDATA["price"] = $("#price").val();
                jsonDATA["pice"] = $("input[name='radio_pice']:checked").val();
                jsonDATA["pnote"] = $("#pnote").val();

                console.log(JSON.stringify(jsonDATA));
                //傳遞至API執行更新行為
                $.ajax({
                    type: "POST",
                    url: "20250812-product01-contron-API.php?action=updateproduct",
                    data: JSON.stringify(jsonDATA),
                    dataType: "json",
                    success: showdata_update,
                    error: function () {
                        Swal.fire({
                            title: "前台連線錯誤! - 20250812-product01-contron-API.php?action=updateproduct",
                            icon: "error",
                            draggable: true
                        });
                    }
                });
            });

            //產品價格即時監聽
            $("#price").bind("input propertychange", function () {
                let priceVal = $(this).val();

                if (priceVal > 0 && priceVal < 10000) {
                    //符合規定
                    $(this).removeClass("is-invalid");
                    $(this).addClass("is-valid");
                    flag_price = true;
                } else if (priceVal <= 0) {
                    //不符合規定
                    $(this).removeClass("is-valid");
                    $(this).addClass("is-invalid");
                    $("#price_invalid-feedback").text("不符合規定!");
                    flag_price = false;
                } else {
                    //不符合規定
                    $(this).removeClass("is-valid");
                    $(this).addClass("is-invalid");
                    $("#price_invalid-feedback").text("價格太貴啦!");
                    flag_price = false;
                }
            })
        });

        function showdata_getalldata(data) {
            console.log(data);
            $("#mydata").empty();
            data.data.forEach(function (item) {
                let strHTML = `<div class="col-sm-6 col-md-4 col-lg-3 mt-3">
                                <div class="card shadow-lg h-100">
                                    <img src="${item.Pimg}" class="card-img-top" alt="${item.Pimg}">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title fs-2 fw-900">${item.Pname}</h5>
                                        <p class="card-text">價格: <span class="fs-3 fw-900 text-danger">${item.Price}</span>元</p>
                                        <p class="card-text">狀態: <span class="fs-4 fw-900 text-success">${item.Pice}</span></p>
                                        <p class="card-text">說明: 
                                        <textarea id="detail_desc" class="form-control" rows="5"
                                    placeholder="賣方簡短描述、配件、瑕疵說明…" disabled>${item.Pnote}</textarea>
                                        </p>
                                        <div class="text-center mt-auto">
                                            
                                            <a href="#" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#updateModal" 
                                            data-pname="${item.Pname}" 
                                            data-id="${item.ID}" 
                                            data-price="${item.Price}" 
                                            data-pice="${item.Pice}" 
                                            data-pnote="${item.Pnote}"
                                            id="update_btn">
                                            <i class="fa-solid fa-pencil me-2 text-danger"></i>更新</a>

                                            <a href="#" class="btn btn-danger" data-id="${item.ID}" id="delete_btn">
                                            <i class="fa-solid fa-trash-can me-2 text-warning"></i>刪除</a>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                $("#mydata").append(strHTML);
            });
        }


        function showdata_update(data) {
            console.log(data);
            if (data.state) {
                Swal.fire({
                    title: data.message,
                    showDenyButton: false,
                    showCancelButton: false,
                    confirmButtonText: "確認",
                    icon: "success",
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.href = "20250812-product01-list.html";
                    }
                });
            } else {
                Swal.fire({
                    title: data.message,
                    icon: "error",
                    draggable: true
                });
            }
        }

        function showdata_delete(data) {
            console.log(data);
            if (data.state) {
                Swal.fire({
                    title: data.message,
                    showDenyButton: false,
                    showCancelButton: false,
                    confirmButtonText: "確認",
                    icon: "success",
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.href = "20250812-product01-list.html";
                    }
                });
            } else {
                Swal.fire({
                    title: data.message,
                    icon: "error",
                    draggable: true
                });
            }
        }
    </script>
</body>

</html>